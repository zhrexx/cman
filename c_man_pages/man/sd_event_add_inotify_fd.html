<!-- Creator     : groff version 1.23.0 -->
<!-- CreationDate: Sat Apr  5 19:50:59 2025 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
<meta content="groff -Thtml, see www.gnu.org" name="generator"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="text/css" name="Content-Style"/>
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>SD_EVENT_ADD_INOTIFY</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><style>
            :root {
                --primary-color: #3498db;
                --background-color: #f9f9f9;
                --text-color: #333;
                --code-bg: #f0f0f0;
                --header-color: #2c3e50;
                --link-color: #2980b9;
            }
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                color: var(--text-color);
                background-color: var(--background-color);
                max-width: 900px;
                margin: 0 auto;
                padding: 2rem;
            }
            h1, h2, h3, h4 {
                color: var(--header-color);
            }
            h1 {
                border-bottom: 2px solid var(--primary-color);
                padding-bottom: 0.5rem;
            }
            pre {
                background-color: var(--code-bg);
                padding: 1rem;
                border-radius: 4px;
                overflow-x: auto;
            }
            a {
                color: var(--link-color);
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
            }
            .man-navigation {
                background-color: #fff;
                border-bottom: 1px solid #ddd;
                padding: 0.5rem 0;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            .section {
                margin-top: 2rem;
            }
            @media (prefers-color-scheme: dark) {
                :root {
                    --primary-color: #3498db;
                    --background-color: #222;
                    --text-color: #f0f0f0;
                    --code-bg: #333;
                    --header-color: #3498db;
                    --link-color: #5dade2;
                }
            }
            .back-to-index {
                display: inline-block;
                margin: 1rem 0;
                padding: 0.5rem 1rem;
                background-color: var(--primary-color);
                color: white;
                border-radius: 4px;
                text-decoration: none;
            }
            .back-to-index:hover {
                background-color: var(--link-color);
                text-decoration: none;
            }
        </style></head>
<body><div><a class="back-to-index" href="../index.html">← Back to Index</a></div>
<h1 align="center">SD_EVENT_ADD_INOTIFY</h1>
<a href="#NAME">NAME</a><br/>
<a href="#SYNOPSIS">SYNOPSIS</a><br/>
<a href="#DESCRIPTION">DESCRIPTION</a><br/>
<a href="#RETURN VALUE">RETURN VALUE</a><br/>
<a href="#Errors">Errors</a><br/>
<a href="#EXAMPLES">EXAMPLES</a><br/>
<a href="#NOTES">NOTES</a><br/>
<a href="#HISTORY">HISTORY</a><br/>
<a href="#SEE ALSO">SEE ALSO</a><br/>
<hr/>
<h2>NAME
<a name="NAME"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em">sd_event_add_inotify,
sd_event_add_inotify_fd, sd_event_source_get_inotify_mask,
sd_event_source_get_inotify_path, sd_event_inotify_handler_t
− Add an "inotify" file system inode event
source to an event loop</p>
<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em"><b>#include
&lt;systemd/sd−event.h&gt;</b></p>
<p style="margin-left:9%; margin-top: 1em"><b>typedef
struct sd_event_source sd_event_source;</b></p>
<table border="0" cellpadding="0" cellspacing="0" frame="void" rules="none" width="100%">
<tr align="left" valign="top">
<td width="9%"></td>
<td width="91%">
<p style="margin-top: 1em"><b>typedef int
(*sd_event_inotify_handler_t)(sd_event_source *</b><i>s</i><b>,
const struct inotify_event *</b><i>event</i><b>,
void *</b><i>userdata</i><b>);</b></p> </td></tr>
<tr align="left" valign="top">
<td width="9%"></td>
<td width="91%">
<p style="margin-top: 1em"><b>int
sd_event_add_inotify(sd_event *</b><i>event</i><b>,
sd_event_source **</b><i>source</i><b>,
const char *</b><i>path</i><b>,
uint32_t </b><i>mask</i><b>,
sd_event_inotify_handler_t </b><i>handler</i><b>,
void *</b><i>userdata</i><b>);</b></p> </td></tr>
<tr align="left" valign="top">
<td width="9%"></td>
<td width="91%">
<p style="margin-top: 1em"><b>int
sd_event_add_inotify_fd(sd_event *</b><i>event</i><b>,
sd_event_source **</b><i>source</i><b>,
int </b><i>fd</i><b>, uint32_t </b><i>mask</i><b>,
sd_event_inotify_handler_t </b><i>handler</i><b>,
void *</b><i>userdata</i><b>);</b></p> </td></tr>
<tr align="left" valign="top">
<td width="9%"></td>
<td width="91%">
<p style="margin-top: 1em"><b>int
sd_event_source_get_inotify_mask(sd_event_source *</b><i>source</i><b>,
uint32_t *</b><i>ret</i><b>);</b></p> </td></tr>
<tr align="left" valign="top">
<td width="9%"></td>
<td width="91%">
<p style="margin-top: 1em"><b>int
sd_event_source_get_inotify_path(sd_event_source *</b><i>source</i><b>,
const char **</b><i>ret</i><b>);</b></p> </td></tr>
</table>
<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_add_inotify()</b>
adds a new <b>inotify</b>(7) file system inode event source
to an event loop. The event loop object is specified in the
<i>event</i> parameter, the event source object is returned
in the <i>source</i> parameter. The <i>path</i> parameter
specifies the path of the file system inode to watch. The
<i>mask</i> parameter specifies which types of inode events
to watch specifically. It must contain an OR−ed
combination of <b>IN_ACCESS</b>, <b>IN_ATTRIB</b>,
<b>IN_CLOSE_WRITE</b>, ... flags. See <b>inotify</b>(7) for
further information.</p>
<p style="margin-left:9%; margin-top: 1em">The
<i>handler</i> must reference a function to call when the
inode changes or <b>NULL</b>. The handler function will be
passed the <i>userdata</i> pointer, which may be chosen
freely by the caller. The handler also receives a pointer to
a struct inotify_event structure containing information
about the inode event. The handler may return negative to
signal an error (see below), other return values are
ignored. If <i>handler</i> is <b>NULL</b>, a default handler
that calls <b>sd_event_exit</b>(3) will be used.</p>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_add_inotify_fd()</b>
is identical to <b>sd_event_add_inotify()</b>, except that
it takes a file descriptor to an inode (possibly an
<b>O_PATH</b> one, but any other will do too) instead of a
path in the file system.</p>
<p style="margin-left:9%; margin-top: 1em">If multiple
event sources are installed for the same inode the backing
inotify watch descriptor is automatically shared. The mask
parameter may contain any flag defined by the inotify API,
with the exception of <b>IN_MASK_ADD</b>.</p>
<p style="margin-left:9%; margin-top: 1em">The handler is
enabled continuously (<b>SD_EVENT_ON</b>), but this may be
changed with <b>sd_event_source_set_enabled</b>(3).
Alternatively, the <b>IN_ONESHOT</b> mask flag may be used
to request <b>SD_EVENT_ONESHOT</b> mode. If the handler
function returns a negative error code, it will be disabled
after the invocation, even if the <b>SD_EVENT_ON</b> mode
was requested before.</p>
<p style="margin-left:9%; margin-top: 1em">As a special
limitation the priority of inotify event sources may only be
altered (see <b>sd_event_source_set_priority</b>(3)) in the
time between creation of the event source object with
<b>sd_event_add_inotify()</b> and the beginning of the next
event loop iteration. Attempts of changing the priority any
later will be refused. Consider freeing and allocating a new
inotify event source to change the priority at that
point.</p>
<p style="margin-left:9%; margin-top: 1em">To destroy an
event source object use <b>sd_event_source_unref</b>(3), but
note that the event source is only removed from the event
loop when all references to the event source are dropped. To
make sure an event source does not fire anymore, even when
there's still a reference to it kept, consider disabling it
with <b>sd_event_source_set_enabled</b>(3).</p>
<p style="margin-left:9%; margin-top: 1em">If the second
parameter of <b>sd_event_add_inotify()</b> is passed as
<b>NULL</b> no reference to the event source object is
returned. In this case the event source is considered
"floating", and will be destroyed implicitly when
the event loop itself is destroyed.</p>
<p style="margin-left:9%; margin-top: 1em">If the
<i>handler</i> parameter to <b>sd_event_add_inotify()</b> is
<b>NULL</b>, and the event source fires, this will be
considered a request to exit the event loop. In this case,
the <i>userdata</i> parameter, cast to an integer, is passed
as the exit code parameter to <b>sd_event_exit</b>(3).</p>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_source_get_inotify_mask()</b>
retrieves the configured inotify watch mask of an event
source created previously with
<b>sd_event_add_inotify()</b>. It takes the event source
object as the <i>source</i> parameter and a pointer to a
<b>uint32_t</b> variable to return the mask in.</p>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_source_get_inotify_path()</b>
retrieves the target path of the configured inotify watch of
an event source created previously with
<b>sd_event_add_inotify()</b>. It takes the event source
object as the <i>source</i> parameter and a pointer to a
<b>const char **</b> variable to return the path in. The
caller must not free the returned path.</p>
<h2>RETURN VALUE
<a name="RETURN VALUE"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em">On success,
these functions return 0 or a positive integer. On failure,
they return a negative errno−style error code.</p>
<h3>Errors
<a name="Errors"></a>
</h3>
<p style="margin-left:9%; margin-top: 1em">Returned errors
may indicate the following problems:</p>
<p style="margin-left:9%; margin-top: 1em"><b>−ENOMEM</b></p>
<p style="margin-left:14%;">Not enough memory to allocate
an object.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−EINVAL</b></p>
<p style="margin-left:14%;">An invalid argument has been
passed. This includes specifying a mask with
<b>IN_MASK_ADD</b> set.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−ESTALE</b></p>
<p style="margin-left:14%;">Returned by
<b>sd_event_source_add_inotify()</b> or
<b>sd_event_source_add_inotify_fd()</b> when the event loop
is already terminated. Returned by
<b>sd_event_source_get_inotify_path()</b> when no active
inode data is assigned to the event source, e.g. when the
event source is disabled.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−ECHILD</b></p>
<p style="margin-left:14%;">The event loop has been created
in a different process, library or module instance.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−EDOM</b></p>
<p style="margin-left:14%;">The passed event source is not
an inotify process event source.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−EBADF</b></p>
<p style="margin-left:14%;">The passed file descriptor is
not valid.</p>
<p style="margin-left:9%; margin-top: 1em"><b>−ENOSYS</b></p>
<p style="margin-left:14%;"><b>sd_event_add_inotify_fd()</b>
or <b>sd_event_source_get_inotify_path()</b> was called
without /proc/ mounted.</p>
<h2>EXAMPLES
<a name="EXAMPLES"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em"><b>Example 1. A
simple program that uses inotify to monitor one or two
directories</b></p>
<p style="margin-left:14%; margin-top: 1em">/*
SPDX−License−Identifier: MIT−0 */</p>
<p style="margin-left:14%; margin-top: 1em">#include
&lt;stdio.h&gt; <br/>
#include &lt;string.h&gt; <br/>
#include &lt;sys/inotify.h&gt;</p>
<p style="margin-left:14%; margin-top: 1em">#include
&lt;systemd/sd−event.h&gt;</p>
<p style="margin-left:14%; margin-top: 1em">#define
_cleanup_(f) __attribute__((cleanup(f)))</p>
<p style="margin-left:14%; margin-top: 1em">static int
inotify_handler(sd_event_source *source, <br/>
const struct inotify_event *event, <br/>
void *userdata) {</p>
<p style="margin-left:14%; margin-top: 1em">const char
*desc = NULL;</p>
<p style="margin-left:14%; margin-top: 1em">sd_event_source_get_description(source,
&amp;desc);</p>
<p style="margin-left:14%; margin-top: 1em">if
(event−&gt;mask &amp; IN_Q_OVERFLOW) <br/>
printf("inotify−handler &lt;%s&gt;:
overflow\n", desc); <br/>
else if (event−&gt;mask &amp; IN_CREATE) <br/>
printf("inotify−handler &lt;%s&gt;: create on
%s\n", desc, event−&gt;name); <br/>
else if (event−&gt;mask &amp; IN_DELETE) <br/>
printf("inotify−handler &lt;%s&gt;: delete on
%s\n", desc, event−&gt;name); <br/>
else if (event−&gt;mask &amp; IN_MOVED_TO) <br/>
printf("inotify−handler &lt;%s&gt;:
moved−to on %s\n", desc,
event−&gt;name);</p>
<p style="margin-left:14%; margin-top: 1em">/* Terminate
the program if an "exit" file appears */ <br/>
if ((event−&gt;mask &amp; (IN_CREATE|IN_MOVED_TO))
&amp;&amp; <br/>
strcmp(event−&gt;name, "exit") == 0) <br/>
sd_event_exit(sd_event_source_get_event(source), 0);</p>
<p style="margin-left:14%; margin-top: 1em">return 1; <br/>
}</p>
<p style="margin-left:14%; margin-top: 1em">int main(int
argc, char **argv) { <br/>
_cleanup_(sd_event_unrefp) sd_event *event = NULL; <br/>
_cleanup_(sd_event_source_unrefp) sd_event_source *source1 =
NULL, *source2 = NULL;</p>
<p style="margin-left:14%; margin-top: 1em">const char
*path1 = argc &gt; 1 ? argv[1] : "/tmp"; <br/>
const char *path2 = argc &gt; 2 ? argv[2] : NULL;</p>
<p style="margin-left:14%; margin-top: 1em">/* Note:
failure handling is omitted for brevity */</p>
<p style="margin-left:14%; margin-top: 1em">sd_event_default(&amp;event);</p>
<p style="margin-left:14%; margin-top: 1em">sd_event_add_inotify(event,
&amp;source1, path1, <br/>
IN_CREATE | IN_DELETE | IN_MODIFY | IN_MOVED_TO, <br/>
inotify_handler, NULL); <br/>
if (path2) <br/>
sd_event_add_inotify(event, &amp;source2, path2, <br/>
IN_CREATE | IN_DELETE | IN_MODIFY | IN_MOVED_TO, <br/>
inotify_handler, NULL);</p>
<p style="margin-left:14%; margin-top: 1em">sd_event_loop(event);</p>
<p style="margin-left:14%; margin-top: 1em">return 0; <br/>
}</p>
<h2>NOTES
<a name="NOTES"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em">Functions
described here are available as a shared library, which can
be compiled against and linked to with the
<b>libsystemd pkg-config</b>(1) file.</p>
<p style="margin-left:9%; margin-top: 1em">The code
described here uses <b>getenv</b>(3), which is declared to
be not multi−thread−safe. This means that the
code calling the functions described here must not call
<b>setenv</b>(3) from a parallel thread. It is recommended
to only do calls to <b>setenv()</b> from an early phase of
the program when no other threads have been started.</p>
<h2>HISTORY
<a name="HISTORY"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_inotify_handler_t()</b>,
<b>sd_event_add_inotify()</b>, and
<b>sd_event_source_get_inotify_mask()</b> were added in
version 239.</p>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_add_inotify_fd()</b>
was added in version 250.</p>
<p style="margin-left:9%; margin-top: 1em"><b>sd_event_source_get_inotify_path()</b>
was added in version 256.</p>
<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>
<p style="margin-left:9%; margin-top: 1em"><b>systemd</b>(1),
<b>sd-event</b>(3), <b>sd_event_new</b>(3),
<b>sd_event_now</b>(3), <b>sd_event_add_io</b>(3),
<b>sd_event_add_time</b>(3), <b>sd_event_add_signal</b>(3),
<b>sd_event_add_defer</b>(3), <b>sd_event_add_child</b>(3),
<b>sd_event_source_set_enabled</b>(3),
<b>sd_event_source_set_priority</b>(3),
<b>sd_event_source_set_userdata</b>(3),
<b>sd_event_source_set_description</b>(3),
<b>sd_event_source_set_floating</b>(3), <b>waitid</b>(2)</p>
<hr/>
</body>
</html>
